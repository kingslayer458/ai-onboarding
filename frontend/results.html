<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>SOC Security Report</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
<style>
* {
  margin: 0;
  padding: 0;
  box-sizing: border-box;
}

body {
  font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
  background: #fbfbfd;
  color: #1d1d1f;
  line-height: 1.5;
  min-height: 100vh;
  padding: 32px 20px;
  -webkit-font-smoothing: antialiased;
  -moz-osx-font-smoothing: grayscale;
}

.container {
  max-width: 1100px;
  margin: 0 auto;
  opacity: 0;
  animation: fadeIn 0.8s ease forwards;
}

@keyframes fadeIn {
  to { opacity: 1; }
}

header {
  margin-bottom: 40px;
  padding-bottom: 20px;
  border-bottom: 1px solid #d2d2d7;
}

h1 {
  font-size: 2.25rem;
  font-weight: 600;
  margin-bottom: 6px;
  letter-spacing: -0.03em;
}

.subtitle {
  color: #6e6e73;
  font-size: 0.95rem;
  font-weight: 400;
}

.score-section {
  background: #ffffff;
  border: 1px solid #d2d2d7;
  border-radius: 12px;
  padding: 36px;
  margin-bottom: 28px;
  text-align: center;
  transition: transform 0.3s ease, box-shadow 0.3s ease;
  box-shadow: 0 2px 8px rgba(0,0,0,0.04);
}

.score-section:hover {
  transform: translateY(-2px);
  box-shadow: 0 4px 20px rgba(0,0,0,0.06);
}

.score-number {
  font-size: 3.5rem;
  font-weight: 600;
  line-height: 1;
  margin-bottom: 14px;
  letter-spacing: -0.02em;
}

.severity-badge {
  display: inline-block;
  padding: 6px 16px;
  border-radius: 6px;
  font-weight: 500;
  font-size: 0.85rem;
  text-transform: uppercase;
  letter-spacing: 0.03em;
}

.high { 
  background: rgba(239,68,68,0.15);
  color: #ef4444;
  border: 1px solid rgba(239,68,68,0.3);
}

.medium { 
  background: rgba(245,158,11,0.15);
  color: #f59e0b;
  border: 1px solid rgba(245,158,11,0.3);
}

.low { 
  background: rgba(34,197,94,0.15);
  color: #22c55e;
  border: 1px solid rgba(34,197,94,0.3);
}

.grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
  gap: 20px;
  margin-bottom: 28px;
}

.card {
  background: #ffffff;
  border: 1px solid rgba(255,255,255,0.08);
  border-radius: 12px;
  padding: 24px;
  transition: all 0.3s ease;
}

.card:hover {
  transform: translateY(-2px);
  border-color: rgba(255,255,255,0.15);
}

.card h3 {
  font-size: 1.1rem;
  font-weight: 600;
  margin-bottom: 18px;
  padding-bottom: 10px;
  border-bottom: 1px solid #d2d2d7;
}

.card ul {
  list-style: none;
}

.card li {
  padding: 10px 0;
  border-bottom: 1px solid #f5f5f7;
  transition: padding-left 0.2s ease;
  font-size: 0.9rem;
  color: #6e6e73;
  font-weight: 400;
}

.card li:last-child {
  border-bottom: none;
}

.card li:hover {
  padding-left: 8px;
}

.card li b {
  color: #1d1d1f;
  font-weight: 500;
}

.full-width {
  grid-column: 1 / -1;
}

button {
  display: block;
  margin: 40px auto 0;
  padding: 14px 40px;
  background: #000000;
  color: #f0f0f0;
  border: none;
  border-radius: 10px;
  font-size: 0.95rem;
  font-weight: 500;
  cursor: pointer;
  transition: all 0.3s ease;
}

button:hover {
  transform: translateY(-2px);
  box-shadow: 0 8px 24px rgba(255,255,255,0.2);
}

button:active {
  transform: translateY(0);
}

.preloader {
  position: fixed;
  top: 0;
  left: 0;
  width: 100vw;
  height: 100vh;
  background: #fbfbfd;
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 9999;
  transition: opacity 0.5s ease;
}

.preloader.hidden {
  opacity: 0;
  pointer-events: none;
}

.loader {
  width: 40px;
  height: 40px;
  border: 2px solid rgba(0,0,0,0.1);
  border-top-color: #000000;
  border-radius: 50%;
  animation: spin 0.8s linear infinite;
}

@keyframes spin {
  to { transform: rotate(360deg); }
}

a {
  color: #0071e3;
  text-decoration: underline;
  transition: opacity 0.2s ease;
}

body.light a {
  color: #000000;
}

a:hover {
  opacity: 0.7;
}

@media (max-width: 768px) {
  h1 {
    font-size: 1.75rem;
  }
  
  .score-number {
    font-size: 2.75rem;
  }
  
  .score-section {
    padding: 28px 20px;
  }
  
  .card {
    padding: 20px;
  }
}
</style>
</head>
<body>
  <div class="preloader" id="preloader">
    <div class="loader"></div>
  </div>

  <div class="container">
    <header>
      <h1>Security Assessment</h1>
      <p class="subtitle">Comprehensive System Security Analysis</p>
    </header>

    <div class="score-section">
      <div class="score-number" id="score">—</div>
      <div id="severity"></div>
    </div>

    <div class="grid">
      <div class="card">
        <h3>System Configuration</h3>
        <ul id="system"></ul>
      </div>
      
      <div class="card">
        <h3>Security Configuration</h3>
        <ul id="security"></ul>
      </div>
    </div>

    <div class="grid">
      <div class="card full-width">
        <h3>Findings</h3>
        <ul id="findings"></ul>
      </div>
    </div>

    

    <button onclick="location.href='onboarding.html'">
      Proceed to AI Onboarding
    </button>
  </div>

  <script>
    // Check system preference and apply theme
    if (window.matchMedia && window.matchMedia('(prefers-color-scheme: light)').matches) {
      document.body.classList.remove('dark');
      document.body.classList.add('light');
    }

    function hidePreloader() {
      const preloader = document.getElementById('preloader');
      preloader.classList.add('hidden');
    }

    window.onload = function() {
      setTimeout(hidePreloader, 1200);
    }

    // Load report data from localStorage
    const r = JSON.parse(localStorage.getItem("report") || '{}');

    // Populate score
    const scoreEl = document.getElementById('score');
    if (r.score !== undefined) {
      scoreEl.innerText = r.score + "/100";
    }

    // Populate severity
    const severityEl = document.getElementById('severity');
    if (r.severity) {
      const severityClass = r.severity.toLowerCase();
      severityEl.innerHTML = `<span class="severity-badge ${severityClass}">Severity: ${r.severity}</span>`;
    }

    // Populate system info
    const systemEl = document.getElementById('system');
    if (r.system) {
      const s = r.system;
      systemEl.innerHTML = `
        <li><b>Hostname:</b> ${s.hostname || 'N/A'}</li>
        <li><b>OS:</b> ${s.os || 'N/A'}</li>
        <li><b>Architecture:</b> ${s.architecture || 'N/A'}</li>
        <li><b>CPU Cores:</b> ${s.cpu_cores || 'N/A'}</li>
        <li><b>CPU Usage:</b> ${s.cpu_usage || 0}%</li>
        <li><b>RAM:</b> ${s.ram_total_gb || 0} GB (${s.ram_usage || 0}% used)</li>
        <li><b>Disk:</b> ${s.disk_total_gb || 0} GB (${s.disk_usage || 0}% used)</li>
        <li><b>Uptime:</b> ${Math.round((s.uptime_hours || 0)/3600)} hrs</li>
        <li><b>IP Address:</b> ${s.ip_address || 'N/A'}</li>
        <li><b>Logged-in Users:</b> ${s.logged_in_users || 0}</li>
      `;
    }

    // Populate security info
    const securityEl = document.getElementById('security');
    if (r.security) {
      const sec = r.security;
      const nmap = sec.nmap || {};
      const nmapPorts = nmap.open_ports || [];
      const clamav = r.clamav || sec.clamav || {};
      
      securityEl.innerHTML = `
        <li><b>Firewall:</b> ${sec.firewall || 'N/A'}</li>
        <li><b>Defender:</b> ${sec.defender || 'N/A'}</li>
        <li><b>RDP Enabled:</b> ${sec.rdp || 'N/A'}</li>
        <li><b>SMBv1:</b> ${sec.smb_v1 || 'N/A'}</li>
        <li><b>Failed Logins:</b> ${sec.failed_logins || 0}</li>
        <li><b>Open Ports:</b> ${(sec.open_ports || []).join(", ") || 'None'}</li>
       <li><b>Nmap Scan:</b><br>
  <ul style="margin-left:1em;">
    ${
      nmap.status === "COMPLETED"
        ? nmapPorts.map(p =>
            `<li>${p.port} — ${p.service}</li>`
          ).join("")
        : `<li>${nmap.status || "N/A"}</li>`
    }
  </ul>
</li>
 
  </span><br>
  

  ${clamav.infected_files && clamav.infected_files.length
    ? `<ul style='margin-left:1em;'>${clamav.infected_files.map(f=>`<li>${f}</li>`).join("")}</ul>`
    : ''
  }

  <br>
  <a href="#" onclick="viewClamAV()">View Full Report</a>

  <pre id="clamavReport"
       style="display:none;
              max-height:300px;
              margin-top:12px;
              overflow:auto;
              background:#0b0b0b;
              color:#00ff88;
              padding:14px;
              border-radius:8px;
              font-size:0.8rem;
              line-height:1.4;">
  </pre>
</li>
          Status: <span style="font-weight:600; color:${clamav.status==='INFECTED'?'#ef4444':'#22c55e'}">${clamav.status || 'N/A'}</span><br>
          Infected Files: ${clamav.infected_count || 0}
          ${clamav.infected_files && clamav.infected_files.length ? `<ul style='margin-left:1em;'>${clamav.infected_files.map(f=>`<li>${f}</li>`).join("")}</ul>` : ''}
          
        </li>
      `;
    }

    // Populate findings
    const findingsEl = document.getElementById('findings');
    if (r.findings && r.findings.length) {
      findingsEl.innerHTML = r.findings.map(f => `<li>${f}</li>`).join("");
    } else {
      findingsEl.innerHTML = "<li>No critical issues detected</li>";
    }

    // Populate SOC response
    // const socEl = document.getElementById('soc');
    // if (r.soc_response && r.soc_response.length) {
    //   socEl.innerHTML = r.soc_response.map(s => `<li>${s}</li>`).join("");
    // } else {
    //   socEl.innerHTML = "<li>No response actions required</li>";
    // }
function viewClamAV() {
  const report = JSON.parse(localStorage.getItem("report") || "{}")
  if (!report.scan_id) {
    alert("Scan ID not found")
    return
  }

  fetch(`http://localhost:3000/api/clamav-report/${report.scan_id}`)
    .then(r => {
      if (!r.ok) throw new Error("Report not available yet")
      return r.text()
    })
    .then(text => {
      const pre = document.getElementById("clamavReport")
      pre.textContent = text || "No threats detected."
      pre.style.display = "block"
    })
    .catch(err => {
      alert(err.message)
    })
}
  </script>
</body>
</html>